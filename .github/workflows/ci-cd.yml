name: CI/CD Pipeline - Automa√ß√£o QA

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  api-tests:
    name: Testes de API (Cypress)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"

      - name: Instalar depend√™ncias do sistema
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk2.0-0 libgtk-3-0 libgbm-dev libnotify-dev libgconf-2-4 libnss3 libxss1 libasound2 libxtst6 xauth xvfb

      - name: Instalar depend√™ncias
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: Verificar estrutura do projeto
        run: |
          echo "üìÅ Estrutura do projeto:"
          ls -la api-tests/ || echo "‚ö†Ô∏è Pasta api-tests n√£o encontrada"
          echo ""
          echo "üì¶ Depend√™ncias instaladas:"
          npm list cypress || echo "‚ö†Ô∏è Cypress n√£o encontrado"

      - name: Verificar instala√ß√£o do Cypress
        run: |
          npx cypress verify || echo "‚ö†Ô∏è Cypress verification failed, continuing..."
          npx cypress version || echo "‚ö†Ô∏è Cypress version check failed"

      - name: Executar testes de API
        run: |
          set -e
          echo "üöÄ Iniciando testes de API..."
          npm run api:test || {
            echo "‚ùå Testes falharam com c√≥digo de sa√≠da: $?"
            echo "üìã Verificando logs..."
            ls -la api-tests/videos/ 2>/dev/null || echo "Nenhum v√≠deo gerado"
            ls -la api-tests/screenshots/ 2>/dev/null || echo "Nenhum screenshot gerado"
            exit 1
          }
        env:
          API_BASE_URL: ${{ secrets.API_BASE_URL || 'https://jsonplaceholder.typicode.com' }}
          DEBUG: cypress:*

      - name: Upload evid√™ncias de v√≠deo
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: api-test-videos
          path: api-tests/videos

      - name: Upload screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: api-test-screenshots
          path: api-tests/screenshots

  web-tests:
    name: Testes Web E2E (Cypress + Cucumber)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"

      - name: Instalar depend√™ncias do sistema
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk2.0-0 libgtk-3-0 libgbm-dev libnotify-dev libgconf-2-4 libnss3 libxss1 libasound2 libxtst6 xauth xvfb

      - name: Instalar depend√™ncias
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: Verificar estrutura do projeto
        run: |
          echo "üìÅ Estrutura do projeto:"
          ls -la web-tests/ || echo "‚ö†Ô∏è Pasta web-tests n√£o encontrada"
          echo ""
          echo "üì¶ Depend√™ncias instaladas:"
          npm list cypress @badeball/cypress-cucumber-preprocessor || echo "‚ö†Ô∏è Depend√™ncias n√£o encontradas"

      - name: Verificar instala√ß√£o do Cypress
        run: |
          npx cypress verify || echo "‚ö†Ô∏è Cypress verification failed, continuing..."
          npx cypress version || echo "‚ö†Ô∏è Cypress version check failed"

      - name: Executar testes Web E2E
        run: |
          set -e
          echo "üöÄ Iniciando testes Web E2E..."
          npm run web:test || {
            echo "‚ùå Testes falharam com c√≥digo de sa√≠da: $?"
            echo "üìã Verificando logs..."
            ls -la web-tests/videos/ 2>/dev/null || echo "Nenhum v√≠deo gerado"
            ls -la web-tests/screenshots/ 2>/dev/null || echo "Nenhum screenshot gerado"
            exit 1
          }
        env:
          WEB_BASE_URL: ${{ secrets.WEB_BASE_URL || 'https://www.saucedemo.com' }}
          DEBUG: cypress:*

      - name: Upload evid√™ncias de v√≠deo
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: web-test-videos
          path: web-tests/videos

      - name: Upload screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: web-test-screenshots
          path: web-tests/screenshots

  load-tests:
    name: Testes de Carga (K6)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"

      - name: Instalar depend√™ncias
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: Instalar K6
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D9B
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6

      - name: Executar testes de carga
        run: npm run load:test
        env:
          API_BASE_URL: ${{ secrets.API_BASE_URL || 'https://jsonplaceholder.typicode.com' }}

      - name: Upload relat√≥rio K6
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: k6-report
          path: load-tests/reports

  mobile-tests:
    name: Testes Mobile (Appium)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"

      - name: Instalar depend√™ncias
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: "temurin"
          java-version: "11"

      - name: Instalar Appium
        run: |
          npm install -g appium
          appium driver install uiautomator2
          appium driver install xcuitest

      - name: Iniciar Appium Server
        run: |
          appium --log appium.log &
          sleep 10

      - name: Executar testes Mobile
        run: npm run mobile:test
        env:
          MOBILE_PLATFORM: Android
          MOBILE_DEVICE_NAME: emulator-5554

      - name: Upload relat√≥rio Mobile
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mobile-test-report
          path: mobile-tests/reports

  generate-report:
    name: Gerar Relat√≥rio Consolidado
    needs: [api-tests, web-tests, load-tests, mobile-tests]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"

      - name: Instalar depend√™ncias
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: Baixar artefatos
        uses: actions/download-artifact@v4

      - name: Gerar relat√≥rio consolidado
        run: |
          echo "# Relat√≥rio de Testes - $(date)" > docs/test-report.md
          echo "" >> docs/test-report.md
          echo "## Resumo" >> docs/test-report.md
          echo "- Testes de API: ${{ job.status }}" >> docs/test-report.md
          echo "- Testes Web E2E: ${{ job.status }}" >> docs/test-report.md
          echo "- Testes de Carga: ${{ job.status }}" >> docs/test-report.md
          echo "- Testes Mobile: ${{ job.status }}" >> docs/test-report.md

      - name: Upload relat√≥rio consolidado
        uses: actions/upload-artifact@v4
        with:
          name: consolidated-report
          path: docs/test-report.md
