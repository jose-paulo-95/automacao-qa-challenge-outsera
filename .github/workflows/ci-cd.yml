name: CI/CD Pipeline - Automa√ß√£o QA

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  api-tests:
    name: Testes de API - ${{ matrix.test-file }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        test-file: [users, posts]
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"

      - name: Instalar depend√™ncias do sistema
        run: |
          sudo apt-get update
          # Instalar pacotes essenciais para Cypress
          # Tentar instalar libasound2 (pode ter nome diferente em vers√µes mais recentes)
          sudo apt-get install -y \
            libgtk-3-0 \
            libgbm1 \
            libnss3 \
            libxss1 \
            libxtst6 \
            xauth \
            xvfb \
            libatk-bridge2.0-0 \
            libatk1.0-0 \
            libxcomposite1 \
            libxdamage1 \
            libxfixes3 \
            libxkbcommon0 \
            libxrandr2 \
            fonts-liberation \
            libappindicator3-1 \
            libcups2 \
            libdbus-1-3 \
            libdrm2 || true

          # Tentar instalar libasound2 (pode ter nome diferente)
          sudo apt-get install -y libasound2t64 2>/dev/null || \
          sudo apt-get install -y libasound2 2>/dev/null || \
          echo "‚ö†Ô∏è libasound2 n√£o instalado, continuando..."

      - name: Instalar depend√™ncias
        run: |
          echo "üì¶ Verificando arquivos de depend√™ncias..."
          if [ -f package-lock.json ]; then
            echo "‚úÖ package-lock.json encontrado, usando npm ci"
            npm ci
          elif [ -f package.json ]; then
            echo "‚ö†Ô∏è package-lock.json n√£o encontrado, usando npm install"
            npm install
          else
            echo "‚ùå package.json n√£o encontrado!"
            exit 1
          fi

      - name: Verificar estrutura do projeto
        run: |
          echo "üìÅ Estrutura do projeto:"
          ls -la api-tests/ || echo "‚ö†Ô∏è Pasta api-tests n√£o encontrada"
          echo ""
          echo "üì¶ Depend√™ncias instaladas:"
          npm list cypress || echo "‚ö†Ô∏è Cypress n√£o encontrado"

      - name: Verificar instala√ß√£o do Cypress
        run: |
          npx cypress verify || echo "‚ö†Ô∏è Cypress verification failed, continuing..."
          npx cypress version || echo "‚ö†Ô∏è Cypress version check failed"

      - name: Executar testes de API
        run: |
          set -e
          echo "üöÄ Iniciando testes de API - ${{ matrix.test-file }}..."
          npx cypress run --config-file api-tests/cypress.config.js --spec "api-tests/tests/${{ matrix.test-file }}.spec.js" || {
            echo "‚ùå Testes falharam com c√≥digo de sa√≠da: $?"
            echo "üìã Verificando logs..."
            ls -la api-tests/videos/ 2>/dev/null || echo "Nenhum v√≠deo gerado"
            ls -la api-tests/screenshots/ 2>/dev/null || echo "Nenhum screenshot gerado"
            exit 1
          }
        env:
          API_BASE_URL: ${{ secrets.API_BASE_URL || 'https://jsonplaceholder.typicode.com' }}
          DEBUG: cypress:*

      - name: Upload evid√™ncias de v√≠deo
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: api-test-videos-${{ matrix.test-file }}
          path: api-tests/videos

      - name: Upload screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: api-test-screenshots-${{ matrix.test-file }}
          path: api-tests/screenshots

  web-tests:
    name: Testes Web E2E - ${{ matrix.feature }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        feature: [login, navigation, checkout]
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Verificar estrutura do projeto
        run: |
          echo "üìÅ Diret√≥rio atual:"
          pwd
          echo ""
          echo "üìÅ Conte√∫do do diret√≥rio:"
          ls -la
          echo ""
          echo "üìÑ Verificando package.json:"
          if [ -f package.json ]; then
            echo "‚úÖ package.json encontrado"
          else
            echo "‚ùå package.json N√ÉO encontrado!"
            exit 1
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"

      - name: Instalar depend√™ncias do sistema
        run: |
          sudo apt-get update
          # Instalar pacotes essenciais para Cypress
          # Tentar instalar libasound2 (pode ter nome diferente em vers√µes mais recentes)
          sudo apt-get install -y \
            libgtk-3-0 \
            libgbm1 \
            libnss3 \
            libxss1 \
            libxtst6 \
            xauth \
            xvfb \
            libatk-bridge2.0-0 \
            libatk1.0-0 \
            libxcomposite1 \
            libxdamage1 \
            libxfixes3 \
            libxkbcommon0 \
            libxrandr2 \
            fonts-liberation \
            libappindicator3-1 \
            libcups2 \
            libdbus-1-3 \
            libdrm2 || true

          # Tentar instalar libasound2 (pode ter nome diferente)
          sudo apt-get install -y libasound2t64 2>/dev/null || \
          sudo apt-get install -y libasound2 2>/dev/null || \
          echo "‚ö†Ô∏è libasound2 n√£o instalado, continuando..."

      - name: Instalar depend√™ncias
        run: |
          echo "üì¶ Verificando arquivos de depend√™ncias..."
          if [ -f package-lock.json ]; then
            echo "‚úÖ package-lock.json encontrado, usando npm ci"
            npm ci
          elif [ -f package.json ]; then
            echo "‚ö†Ô∏è package-lock.json n√£o encontrado, usando npm install"
            npm install
          else
            echo "‚ùå package.json n√£o encontrado!"
            exit 1
          fi

      - name: Verificar estrutura do projeto
        run: |
          echo "üìÅ Estrutura do projeto:"
          ls -la web-tests/ || echo "‚ö†Ô∏è Pasta web-tests n√£o encontrada"
          echo ""
          echo "üì¶ Depend√™ncias instaladas:"
          npm list cypress @badeball/cypress-cucumber-preprocessor || echo "‚ö†Ô∏è Depend√™ncias n√£o encontradas"

      - name: Verificar instala√ß√£o do Cypress
        run: |
          npx cypress verify || echo "‚ö†Ô∏è Cypress verification failed, continuing..."
          npx cypress version || echo "‚ö†Ô∏è Cypress version check failed"

      - name: Executar testes Web E2E
        run: |
          set -e
          echo "üöÄ Iniciando testes Web E2E - ${{ matrix.feature }}..."
          npx cypress run --config-file web-tests/cypress.config.js --spec "web-tests/features/${{ matrix.feature }}.feature" || {
            echo "‚ùå Testes falharam com c√≥digo de sa√≠da: $?"
            echo "üìã Verificando logs..."
            ls -la web-tests/videos/ 2>/dev/null || echo "Nenhum v√≠deo gerado"
            ls -la web-tests/screenshots/ 2>/dev/null || echo "Nenhum screenshot gerado"
            exit 1
          }
        env:
          WEB_BASE_URL: ${{ secrets.WEB_BASE_URL || 'https://www.saucedemo.com' }}
          DEBUG: cypress:*

      - name: Upload evid√™ncias de v√≠deo
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: web-test-videos-${{ matrix.feature }}
          path: web-tests/videos

      - name: Upload screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: web-test-screenshots-${{ matrix.feature }}
          path: web-tests/screenshots

  load-tests:
    name: Testes de Carga (K6)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Verificar estrutura do projeto
        run: |
          echo "üìÅ Diret√≥rio atual:"
          pwd
          echo ""
          echo "üìÑ Verificando package.json:"
          if [ -f package.json ]; then
            echo "‚úÖ package.json encontrado"
          else
            echo "‚ùå package.json N√ÉO encontrado!"
            exit 1
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"

      - name: Instalar depend√™ncias
        run: |
          echo "üì¶ Verificando arquivos de depend√™ncias..."
          if [ -f package-lock.json ]; then
            echo "‚úÖ package-lock.json encontrado, usando npm ci"
            npm ci
          elif [ -f package.json ]; then
            echo "‚ö†Ô∏è package-lock.json n√£o encontrado, usando npm install"
            npm install
          else
            echo "‚ùå package.json n√£o encontrado!"
            exit 1
          fi

      - name: Instalar K6
        run: |
          echo "üì¶ Instalando K6 via m√©todo direto (mais confi√°vel)..."

          # Instalar depend√™ncias necess√°rias
          sudo apt-get update
          sudo apt-get install -y curl tar gzip

          # Obter a vers√£o mais recente do K6
          echo "üîç Obtendo vers√£o mais recente do K6..."
          K6_VERSION=$(curl -s https://api.github.com/repos/grafana/k6/releases/latest | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/' | sed 's/v//')

          if [ -z "$K6_VERSION" ]; then
            echo "‚ö†Ô∏è N√£o foi poss√≠vel obter a vers√£o, usando vers√£o fixa..."
            K6_VERSION="0.50.0"
          fi

          echo "üì• Baixando K6 vers√£o ${K6_VERSION}..."
          cd /tmp
          wget -q https://github.com/grafana/k6/releases/download/v${K6_VERSION}/k6-v${K6_VERSION}-linux-amd64.tar.gz -O k6.tar.gz

          echo "üì¶ Extraindo K6..."
          tar -xzf k6.tar.gz

          echo "üìÅ Movendo bin√°rio para /usr/local/bin..."
          sudo mv k6-v${K6_VERSION}-linux-amd64/k6 /usr/local/bin/k6
          sudo chmod +x /usr/local/bin/k6

          echo "üßπ Limpando arquivos tempor√°rios..."
          rm -rf k6-v${K6_VERSION}-linux-amd64* k6.tar.gz

          # Verificar instala√ß√£o
          echo "‚úÖ Verificando instala√ß√£o..."
          k6 version || {
            echo "‚ùå K6 n√£o foi instalado corretamente"
            exit 1
          }
          echo "‚úÖ K6 instalado com sucesso: $(k6 version)"

      - name: Executar testes de carga
        run: npm run load:test
        env:
          API_BASE_URL: ${{ secrets.API_BASE_URL || 'https://jsonplaceholder.typicode.com' }}

      - name: Upload relat√≥rio K6
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: k6-report
          path: load-tests/reports

  mobile-tests:
    name: Testes Mobile - ${{ matrix.test-file }}
    runs-on: ubuntu-latest
    if: false # Skip: testes mobile s√£o apenas mocks
    strategy:
      fail-fast: false
      matrix:
        test-file: [login, navigation, form]
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Verificar estrutura do projeto
        run: |
          echo "üìÅ Diret√≥rio atual:"
          pwd
          echo ""
          echo "üìÑ Verificando package.json:"
          if [ -f package.json ]; then
            echo "‚úÖ package.json encontrado"
          else
            echo "‚ùå package.json N√ÉO encontrado!"
            exit 1
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"

      - name: Instalar depend√™ncias
        run: |
          echo "üì¶ Verificando arquivos de depend√™ncias..."
          if [ -f package-lock.json ]; then
            echo "‚úÖ package-lock.json encontrado, usando npm ci"
            npm ci
          elif [ -f package.json ]; then
            echo "‚ö†Ô∏è package-lock.json n√£o encontrado, usando npm install"
            npm install
          else
            echo "‚ùå package.json n√£o encontrado!"
            exit 1
          fi

      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: "temurin"
          java-version: "11"

      - name: Instalar Appium
        run: |
          echo "üì¶ Instalando Appium..."
          npm install -g appium

          echo "üîç Verificando drivers instalados..."
          appium driver list --installed || echo "Nenhum driver listado ainda"

          echo "üì± Configurando drivers..."
          # Configurar uiautomator2 (necess√°rio para Android)
          # Estrat√©gia: tentar atualizar, se falhar tentar instalar, se ambos falharem verificar se j√° est√° instalado
          echo "üì• Configurando uiautomator2..."
          UPDATE_OUTPUT=$(appium driver update uiautomator2 2>&1) || true
          if echo "$UPDATE_OUTPUT" | grep -q "already installed\|already up to date\|up to date"; then
            echo "‚úÖ uiautomator2 j√° est√° instalado e atualizado"
          elif echo "$UPDATE_OUTPUT" | grep -q "successfully updated\|updated successfully"; then
            echo "‚úÖ uiautomator2 atualizado com sucesso"
          else
            # Tentar instalar
            INSTALL_OUTPUT=$(appium driver install uiautomator2 2>&1) || true
            if echo "$INSTALL_OUTPUT" | grep -q "already installed"; then
              echo "‚úÖ uiautomator2 j√° est√° instalado"
            elif echo "$INSTALL_OUTPUT" | grep -q "successfully installed\|installed successfully"; then
              echo "‚úÖ uiautomator2 instalado com sucesso"
            else
              # Verificar se realmente est√° instalado
              if appium driver list --installed 2>/dev/null | grep -q "uiautomator2"; then
                echo "‚úÖ uiautomator2 j√° est√° instalado (verificado via list)"
              else
                echo "‚ùå Falha ao instalar uiautomator2"
                echo "Update output: $UPDATE_OUTPUT"
                echo "Install output: $INSTALL_OUTPUT"
                exit 1
              fi
            fi
          fi

          # xcuitest √© apenas para iOS, n√£o necess√°rio em Linux/Android
          # Tentar instalar, mas n√£o falhar se n√£o conseguir
          echo "üì• Tentando instalar xcuitest (opcional para iOS)..."
          appium driver update xcuitest 2>/dev/null || \
          appium driver install xcuitest 2>/dev/null || \
          echo "‚ö†Ô∏è xcuitest n√£o instalado (normal em ambiente Linux/Android)"

          echo "‚úÖ Verifica√ß√£o final dos drivers:"
          appium driver list --installed || echo "Nenhum driver listado"

      - name: Iniciar Appium Server
        run: |
          appium --log appium.log &
          sleep 10

      - name: Executar testes Mobile
        run: |
          echo "üöÄ Iniciando testes Mobile - ${{ matrix.test-file }}..."
          npx wdio mobile-tests/appium.conf.js --spec "mobile-tests/tests/${{ matrix.test-file }}.spec.js"
        env:
          MOBILE_PLATFORM: Android
          MOBILE_DEVICE_NAME: emulator-5554

      - name: Upload relat√≥rio Mobile
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mobile-test-report-${{ matrix.test-file }}
          path: mobile-tests/reports

  generate-report:
    name: Gerar Relat√≥rio Consolidado
    needs: [api-tests, web-tests, load-tests]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Verificar estrutura do projeto
        run: |
          echo "üìÅ Diret√≥rio atual:"
          pwd
          echo ""
          echo "üìÑ Verificando package.json:"
          if [ -f package.json ]; then
            echo "‚úÖ package.json encontrado"
          else
            echo "‚ùå package.json N√ÉO encontrado!"
            exit 1
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"

      - name: Instalar depend√™ncias
        run: |
          echo "üì¶ Verificando arquivos de depend√™ncias..."
          if [ -f package-lock.json ]; then
            echo "‚úÖ package-lock.json encontrado, usando npm ci"
            npm ci
          elif [ -f package.json ]; then
            echo "‚ö†Ô∏è package-lock.json n√£o encontrado, usando npm install"
            npm install
          else
            echo "‚ùå package.json n√£o encontrado!"
            exit 1
          fi

      - name: Baixar artefatos
        uses: actions/download-artifact@v4

      - name: Gerar relat√≥rio consolidado
        run: |
          echo "# Relat√≥rio de Testes - $(date)" > docs/test-report.md
          echo "" >> docs/test-report.md
          echo "## Resumo" >> docs/test-report.md
          echo "- Testes de API: ${{ job.status }}" >> docs/test-report.md
          echo "- Testes Web E2E: ${{ job.status }}" >> docs/test-report.md
          echo "- Testes de Carga: ${{ job.status }}" >> docs/test-report.md
          echo "- Testes Mobile: Skipped (apenas mocks)" >> docs/test-report.md

      - name: Upload relat√≥rio consolidado
        uses: actions/upload-artifact@v4
        with:
          name: consolidated-report
          path: docs/test-report.md
