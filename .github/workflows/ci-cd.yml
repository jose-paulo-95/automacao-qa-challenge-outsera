name: CI/CD Pipeline - Automa√ß√£o QA

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  api-tests:
    name: Testes de API - ${{ matrix.test-file }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        test-file: [users, posts]
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"

      - name: Instalar depend√™ncias do sistema
        run: |
          sudo apt-get update
          # Instalar pacotes essenciais para Cypress
          # Tentar instalar libasound2 (pode ter nome diferente em vers√µes mais recentes)
          sudo apt-get install -y \
            libgtk-3-0 \
            libgbm1 \
            libnss3 \
            libxss1 \
            libxtst6 \
            xauth \
            xvfb \
            libatk-bridge2.0-0 \
            libatk1.0-0 \
            libxcomposite1 \
            libxdamage1 \
            libxfixes3 \
            libxkbcommon0 \
            libxrandr2 \
            fonts-liberation \
            libappindicator3-1 \
            libcups2 \
            libdbus-1-3 \
            libdrm2 || true

          # Tentar instalar libasound2 (pode ter nome diferente)
          sudo apt-get install -y libasound2t64 2>/dev/null || \
          sudo apt-get install -y libasound2 2>/dev/null || \
          echo "‚ö†Ô∏è libasound2 n√£o instalado, continuando..."

      - name: Instalar depend√™ncias
        run: |
          echo "üì¶ Verificando arquivos de depend√™ncias..."
          if [ -f package-lock.json ]; then
            echo "‚úÖ package-lock.json encontrado, usando npm ci"
            npm ci
          elif [ -f package.json ]; then
            echo "‚ö†Ô∏è package-lock.json n√£o encontrado, usando npm install"
            npm install
          else
            echo "‚ùå package.json n√£o encontrado!"
            exit 1
          fi

      - name: Verificar estrutura do projeto
        run: |
          echo "üìÅ Estrutura do projeto:"
          ls -la api-tests/ || echo "‚ö†Ô∏è Pasta api-tests n√£o encontrada"
          echo ""
          echo "üì¶ Depend√™ncias instaladas:"
          npm list cypress || echo "‚ö†Ô∏è Cypress n√£o encontrado"

      - name: Verificar instala√ß√£o do Cypress
        run: |
          npx cypress verify || echo "‚ö†Ô∏è Cypress verification failed, continuing..."
          npx cypress version || echo "‚ö†Ô∏è Cypress version check failed"

      - name: Executar testes de API
        run: |
          set -e
          echo "üöÄ Iniciando testes de API - ${{ matrix.test-file }}..."
          npx cypress run --config-file api-tests/cypress.config.js --spec "api-tests/tests/${{ matrix.test-file }}.spec.js" || {
            echo "‚ùå Testes falharam com c√≥digo de sa√≠da: $?"
            echo "üìã Verificando logs..."
            ls -la api-tests/videos/ 2>/dev/null || echo "Nenhum v√≠deo gerado"
            ls -la api-tests/screenshots/ 2>/dev/null || echo "Nenhum screenshot gerado"
            exit 1
          }
        env:
          API_BASE_URL: ${{ secrets.API_BASE_URL || 'https://jsonplaceholder.typicode.com' }}
          DEBUG: cypress:*

      - name: Upload evid√™ncias de v√≠deo
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: api-test-videos-${{ matrix.test-file }}
          path: api-tests/videos

      - name: Upload screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: api-test-screenshots-${{ matrix.test-file }}
          path: api-tests/screenshots

  web-tests:
    name: Testes Web E2E - ${{ matrix.feature }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        feature: [login, navigation, checkout]
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Verificar estrutura do projeto
        run: |
          echo "üìÅ Diret√≥rio atual:"
          pwd
          echo ""
          echo "üìÅ Conte√∫do do diret√≥rio:"
          ls -la
          echo ""
          echo "üìÑ Verificando package.json:"
          if [ -f package.json ]; then
            echo "‚úÖ package.json encontrado"
          else
            echo "‚ùå package.json N√ÉO encontrado!"
            exit 1
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"

      - name: Instalar depend√™ncias do sistema
        run: |
          sudo apt-get update
          # Instalar pacotes essenciais para Cypress
          # Tentar instalar libasound2 (pode ter nome diferente em vers√µes mais recentes)
          sudo apt-get install -y \
            libgtk-3-0 \
            libgbm1 \
            libnss3 \
            libxss1 \
            libxtst6 \
            xauth \
            xvfb \
            libatk-bridge2.0-0 \
            libatk1.0-0 \
            libxcomposite1 \
            libxdamage1 \
            libxfixes3 \
            libxkbcommon0 \
            libxrandr2 \
            fonts-liberation \
            libappindicator3-1 \
            libcups2 \
            libdbus-1-3 \
            libdrm2 || true

          # Tentar instalar libasound2 (pode ter nome diferente)
          sudo apt-get install -y libasound2t64 2>/dev/null || \
          sudo apt-get install -y libasound2 2>/dev/null || \
          echo "‚ö†Ô∏è libasound2 n√£o instalado, continuando..."

      - name: Instalar depend√™ncias
        run: |
          echo "üì¶ Verificando arquivos de depend√™ncias..."
          if [ -f package-lock.json ]; then
            echo "‚úÖ package-lock.json encontrado, usando npm ci"
            npm ci
          elif [ -f package.json ]; then
            echo "‚ö†Ô∏è package-lock.json n√£o encontrado, usando npm install"
            npm install
          else
            echo "‚ùå package.json n√£o encontrado!"
            exit 1
          fi

      - name: Verificar estrutura do projeto
        run: |
          echo "üìÅ Estrutura do projeto:"
          ls -la web-tests/ || echo "‚ö†Ô∏è Pasta web-tests n√£o encontrada"
          echo ""
          echo "üì¶ Depend√™ncias instaladas:"
          npm list cypress @badeball/cypress-cucumber-preprocessor || echo "‚ö†Ô∏è Depend√™ncias n√£o encontradas"

      - name: Verificar instala√ß√£o do Cypress
        run: |
          npx cypress verify || echo "‚ö†Ô∏è Cypress verification failed, continuing..."
          npx cypress version || echo "‚ö†Ô∏è Cypress version check failed"

      - name: Executar testes Web E2E
        run: |
          set -e
          echo "üöÄ Iniciando testes Web E2E - ${{ matrix.feature }}..."
          npx cypress run --config-file web-tests/cypress.config.js --spec "web-tests/features/${{ matrix.feature }}.feature" || {
            echo "‚ùå Testes falharam com c√≥digo de sa√≠da: $?"
            echo "üìã Verificando logs..."
            ls -la web-tests/videos/ 2>/dev/null || echo "Nenhum v√≠deo gerado"
            ls -la web-tests/screenshots/ 2>/dev/null || echo "Nenhum screenshot gerado"
            exit 1
          }
        env:
          WEB_BASE_URL: ${{ secrets.WEB_BASE_URL || 'https://www.saucedemo.com' }}
          DEBUG: cypress:*

      - name: Upload evid√™ncias de v√≠deo
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: web-test-videos-${{ matrix.feature }}
          path: web-tests/videos

      - name: Upload screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: web-test-screenshots-${{ matrix.feature }}
          path: web-tests/screenshots

  load-tests:
    name: Testes de Carga (K6)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Verificar estrutura do projeto
        run: |
          echo "üìÅ Diret√≥rio atual:"
          pwd
          echo ""
          echo "üìÑ Verificando package.json:"
          if [ -f package.json ]; then
            echo "‚úÖ package.json encontrado"
          else
            echo "‚ùå package.json N√ÉO encontrado!"
            exit 1
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"

      - name: Instalar depend√™ncias do sistema (jq para processar JSON)
        run: |
          sudo apt-get update
          sudo apt-get install -y jq bc

      - name: Instalar depend√™ncias
        run: |
          echo "üì¶ Verificando arquivos de depend√™ncias..."
          if [ -f package-lock.json ]; then
            echo "‚úÖ package-lock.json encontrado, usando npm ci"
            npm ci
          elif [ -f package.json ]; then
            echo "‚ö†Ô∏è package-lock.json n√£o encontrado, usando npm install"
            npm install
          else
            echo "‚ùå package.json n√£o encontrado!"
            exit 1
          fi

      - name: Instalar K6
        run: |
          echo "üì¶ Instalando K6 via m√©todo direto (mais confi√°vel)..."

          # Instalar depend√™ncias necess√°rias
          sudo apt-get update
          sudo apt-get install -y curl tar gzip

          # Obter a vers√£o mais recente do K6
          echo "üîç Obtendo vers√£o mais recente do K6..."
          K6_VERSION=$(curl -s https://api.github.com/repos/grafana/k6/releases/latest | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/' | sed 's/v//')

          if [ -z "$K6_VERSION" ]; then
            echo "‚ö†Ô∏è N√£o foi poss√≠vel obter a vers√£o, usando vers√£o fixa..."
            K6_VERSION="0.50.0"
          fi

          echo "üì• Baixando K6 vers√£o ${K6_VERSION}..."
          cd /tmp
          wget -q https://github.com/grafana/k6/releases/download/v${K6_VERSION}/k6-v${K6_VERSION}-linux-amd64.tar.gz -O k6.tar.gz

          echo "üì¶ Extraindo K6..."
          tar -xzf k6.tar.gz

          echo "üìÅ Movendo bin√°rio para /usr/local/bin..."
          sudo mv k6-v${K6_VERSION}-linux-amd64/k6 /usr/local/bin/k6
          sudo chmod +x /usr/local/bin/k6

          echo "üßπ Limpando arquivos tempor√°rios..."
          rm -rf k6-v${K6_VERSION}-linux-amd64* k6.tar.gz

          # Verificar instala√ß√£o
          echo "‚úÖ Verificando instala√ß√£o..."
          k6 version || {
            echo "‚ùå K6 n√£o foi instalado corretamente"
            exit 1
          }
          echo "‚úÖ K6 instalado com sucesso: $(k6 version)"

      - name: Criar diret√≥rio de relat√≥rios
        run: |
          mkdir -p load-tests/reports

      - name: Executar testes de carga e gerar relat√≥rios
        run: |
          echo "üöÄ Iniciando testes de carga com K6..."
          echo "üìä Gerando relat√≥rios em m√∫ltiplos formatos..."

          # Executar K6 com sa√≠da JSON e sum√°rio detalhado
          k6 run \
            --out json=load-tests/reports/k6-results.json \
            --summary-export=load-tests/reports/k6-summary.json \
            load-tests/scripts/load-test.js 2>&1 | tee load-tests/reports/k6-output.txt

          echo "‚úÖ Testes de carga conclu√≠dos!"
        env:
          API_BASE_URL: ${{ secrets.API_BASE_URL || 'https://jsonplaceholder.typicode.com' }}

      - name: Gerar relat√≥rio detalhado do K6
        if: always()
        run: |
          echo "üìù Gerando relat√≥rio detalhado do K6..."

          # Criar diret√≥rio se n√£o existir
          mkdir -p load-tests/reports

          # Verificar se os arquivos de resultado existem
          if [ -f "load-tests/reports/k6-summary.json" ]; then
            echo "‚úÖ Arquivo de sum√°rio encontrado, processando..."
            
            # Gerar relat√≥rio em Markdown
            {
              echo "# üìä Relat√≥rio Detalhado - Testes de Carga (K6)"
              echo ""
              echo "## üìÖ Informa√ß√µes da Execu√ß√£o"
              echo ""
              echo "- **Data/Hora**: $(date '+%Y-%m-%d %H:%M:%S UTC')"
              echo "- **Target API**: ${{ secrets.API_BASE_URL || 'https://jsonplaceholder.typicode.com' }}"
              echo "- **Ferramenta**: K6 $(k6 version | head -1)"
              echo ""
              echo "---"
              echo ""
              echo "## üìà Resumo Executivo"
              echo ""
              
              # Extrair informa√ß√µes do sum√°rio JSON
              if command -v jq &> /dev/null; then
                echo "### Estat√≠sticas Gerais"
                echo ""
                echo "| M√©trica | Valor |"
                echo "|---------|-------|"
                
                # Total de requisi√ß√µes
                TOTAL_REQS=$(jq -r '.metrics.http_reqs.values.count // 0' load-tests/reports/k6-summary.json 2>/dev/null || echo "0")
                echo "| **Total de Requisi√ß√µes** | $TOTAL_REQS |"
                
                # Taxa de requisi√ß√µes por segundo
                RPS=$(jq -r '.metrics.http_reqs.values.rate // 0' load-tests/reports/k6-summary.json 2>/dev/null || echo "0")
                echo "| **Requisi√ß√µes por Segundo (RPS)** | $(printf "%.2f" $RPS) |"
                
                # Taxa de erro
                ERROR_RATE=$(jq -r '.metrics.http_req_failed.values.rate // 0' load-tests/reports/k6-summary.json 2>/dev/null || echo "0")
                ERROR_PERCENT=$(echo "$ERROR_RATE * 100" | bc -l 2>/dev/null || echo "0")
                echo "| **Taxa de Erro** | $(printf "%.2f%%" $ERROR_PERCENT) |"
                
                # Tempo de resposta m√©dio
                AVG_DURATION=$(jq -r '.metrics.http_req_duration.values.avg // 0' load-tests/reports/k6-summary.json 2>/dev/null || echo "0")
                echo "| **Tempo de Resposta M√©dio** | $(printf "%.2f ms" $AVG_DURATION) |"
                
                # P95
                P95=$(jq -r '.metrics.http_req_duration.values["p(95)"] // 0' load-tests/reports/k6-summary.json 2>/dev/null || echo "0")
                echo "| **P95 (95% das requisi√ß√µes)** | $(printf "%.2f ms" $P95) |"
                
                # P99
                P99=$(jq -r '.metrics.http_req_duration.values["p(99)"] // 0' load-tests/reports/k6-summary.json 2>/dev/null || echo "0")
                echo "| **P99 (99% das requisi√ß√µes)** | $(printf "%.2f ms" $P99) |"
                
                # Tempo m√≠nimo
                MIN_DURATION=$(jq -r '.metrics.http_req_duration.values.min // 0' load-tests/reports/k6-summary.json 2>/dev/null || echo "0")
                echo "| **Tempo M√≠nimo** | $(printf "%.2f ms" $MIN_DURATION) |"
                
                # Tempo m√°ximo
                MAX_DURATION=$(jq -r '.metrics.http_req_duration.values.max // 0' load-tests/reports/k6-summary.json 2>/dev/null || echo "0")
                echo "| **Tempo M√°ximo** | $(printf "%.2f ms" $MAX_DURATION) |"
                
                echo ""
                echo "### Status dos Thresholds"
                echo ""
                
                # Verificar thresholds
                THRESHOLDS_PASSED=$(jq -r '.root_group.checks | to_entries[] | select(.value.passes > 0 or .value.fails > 0) | "\(.key): \(if .value.fails == 0 then "‚úÖ Passou" else "‚ùå Falhou" end)"' load-tests/reports/k6-summary.json 2>/dev/null)
                
                if [ -n "$THRESHOLDS_PASSED" ]; then
                  echo "$THRESHOLDS_PASSED" | while IFS= read -r line; do
                    echo "- $line"
                  done
                else
                  echo "- ‚ÑπÔ∏è Informa√ß√µes de thresholds n√£o dispon√≠veis"
                fi
                
              else
                echo "‚ö†Ô∏è jq n√£o est√° instalado. Instalando..."
                sudo apt-get update && sudo apt-get install -y jq
                
                # Tentar novamente
                if command -v jq &> /dev/null; then
                  echo "‚úÖ jq instalado, processando dados..."
                  # Repetir l√≥gica acima
                else
                  echo "‚ùå N√£o foi poss√≠vel instalar jq. Exibindo sum√°rio b√°sico:"
                  echo ""
                  if [ -f "load-tests/reports/k6-output.txt" ]; then
                    echo "### Sa√≠da do K6:"
                    echo ""
                    echo "\`\`\`"
                    tail -50 load-tests/reports/k6-output.txt
                    echo "\`\`\`"
                  fi
                fi
              fi
              
              echo ""
              echo "---"
              echo ""
              echo "## üìä Configura√ß√£o do Teste"
              echo ""
              echo "### Stages de Carga:"
              echo ""
              echo "1. **Ramp-up Inicial**: 0 ‚Üí 100 usu√°rios em 1 minuto"
              echo "2. **Ramp-up Principal**: 100 ‚Üí 500 usu√°rios em 3 minutos"
              echo "3. **Carga Constante**: 500 usu√°rios por 5 minutos"
              echo "4. **Ramp-down**: 500 ‚Üí 0 usu√°rios em 2 minutos"
              echo ""
              echo "**Dura√ß√£o Total**: ~11 minutos"
              echo ""
              echo "### Thresholds Configurados:"
              echo ""
              echo "- ‚úÖ **http_req_duration**: P95 < 500ms, P99 < 1000ms"
              echo "- ‚úÖ **http_req_failed**: Taxa de erro < 1%"
              echo "- ‚úÖ **errors**: Taxa de erro customizada < 1%"
              echo ""
              echo "---"
              echo ""
              echo "## üîç Endpoints Testados"
              echo ""
              echo "1. **GET /posts** - Listagem de posts"
              echo "2. **GET /users** - Listagem de usu√°rios"
              echo "3. **GET /posts/:id** - Busca de post espec√≠fico"
              echo "4. **POST /posts** - Cria√ß√£o de novo post"
              echo ""
              echo "---"
              echo ""
              echo "## üì¶ Arquivos Gerados"
              echo ""
              echo "- üìÑ **k6-summary.json**: Sum√°rio detalhado em JSON"
              echo "- üìÑ **k6-results.json**: Resultados completos em JSON"
              echo "- üìÑ **k6-output.txt**: Sa√≠da completa do console"
              echo ""
              echo "---"
              echo ""
              echo "## üìù Notas"
              echo ""
              echo "- Este relat√≥rio foi gerado automaticamente pelo GitHub Actions"
              echo "- Os dados s√£o extra√≠dos do sum√°rio JSON gerado pelo K6"
              echo "- Para an√°lise detalhada, baixe os arquivos JSON dispon√≠veis nos artefatos"
              echo ""
              echo "---"
              echo ""
              echo "**Gerado em**: $(date '+%Y-%m-%d %H:%M:%S UTC')"
            } > load-tests/reports/k6-report.md
            
            echo "‚úÖ Relat√≥rio detalhado gerado: load-tests/reports/k6-report.md"
            
          else
            echo "‚ö†Ô∏è Arquivo de sum√°rio n√£o encontrado. Gerando relat√≥rio b√°sico..."
            
            {
              echo "# üìä Relat√≥rio - Testes de Carga (K6)"
              echo ""
              echo "## ‚ö†Ô∏è Aviso"
              echo ""
              echo "O arquivo de sum√°rio JSON n√£o foi encontrado. Exibindo sa√≠da do console:"
              echo ""
              echo "\`\`\`"
              if [ -f "load-tests/reports/k6-output.txt" ]; then
                cat load-tests/reports/k6-output.txt
              else
                echo "Nenhuma sa√≠da dispon√≠vel"
              fi
              echo "\`\`\`"
            } > load-tests/reports/k6-report.md
          fi

          echo ""
          echo "üìÑ Pr√©via do relat√≥rio:"
          head -40 load-tests/reports/k6-report.md

      - name: Upload relat√≥rios K6
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: k6-reports
          path: |
            load-tests/reports/k6-report.md
            load-tests/reports/k6-summary.json
            load-tests/reports/k6-results.json
            load-tests/reports/k6-output.txt
          retention-days: 30

  mobile-tests:
    name: Testes Mobile - ${{ matrix.test-file }}
    runs-on: ubuntu-latest
    if: false # Skip: testes mobile s√£o apenas mocks
    strategy:
      fail-fast: false
      matrix:
        test-file: [login, navigation, form]
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Verificar estrutura do projeto
        run: |
          echo "üìÅ Diret√≥rio atual:"
          pwd
          echo ""
          echo "üìÑ Verificando package.json:"
          if [ -f package.json ]; then
            echo "‚úÖ package.json encontrado"
          else
            echo "‚ùå package.json N√ÉO encontrado!"
            exit 1
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"

      - name: Instalar depend√™ncias
        run: |
          echo "üì¶ Verificando arquivos de depend√™ncias..."
          if [ -f package-lock.json ]; then
            echo "‚úÖ package-lock.json encontrado, usando npm ci"
            npm ci
          elif [ -f package.json ]; then
            echo "‚ö†Ô∏è package-lock.json n√£o encontrado, usando npm install"
            npm install
          else
            echo "‚ùå package.json n√£o encontrado!"
            exit 1
          fi

      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: "temurin"
          java-version: "11"

      - name: Instalar Appium
        run: |
          echo "üì¶ Instalando Appium..."
          npm install -g appium

          echo "üîç Verificando drivers instalados..."
          appium driver list --installed || echo "Nenhum driver listado ainda"

          echo "üì± Configurando drivers..."
          # Configurar uiautomator2 (necess√°rio para Android)
          # Estrat√©gia: tentar atualizar, se falhar tentar instalar, se ambos falharem verificar se j√° est√° instalado
          echo "üì• Configurando uiautomator2..."
          UPDATE_OUTPUT=$(appium driver update uiautomator2 2>&1) || true
          if echo "$UPDATE_OUTPUT" | grep -q "already installed\|already up to date\|up to date"; then
            echo "‚úÖ uiautomator2 j√° est√° instalado e atualizado"
          elif echo "$UPDATE_OUTPUT" | grep -q "successfully updated\|updated successfully"; then
            echo "‚úÖ uiautomator2 atualizado com sucesso"
          else
            # Tentar instalar
            INSTALL_OUTPUT=$(appium driver install uiautomator2 2>&1) || true
            if echo "$INSTALL_OUTPUT" | grep -q "already installed"; then
              echo "‚úÖ uiautomator2 j√° est√° instalado"
            elif echo "$INSTALL_OUTPUT" | grep -q "successfully installed\|installed successfully"; then
              echo "‚úÖ uiautomator2 instalado com sucesso"
            else
              # Verificar se realmente est√° instalado
              if appium driver list --installed 2>/dev/null | grep -q "uiautomator2"; then
                echo "‚úÖ uiautomator2 j√° est√° instalado (verificado via list)"
              else
                echo "‚ùå Falha ao instalar uiautomator2"
                echo "Update output: $UPDATE_OUTPUT"
                echo "Install output: $INSTALL_OUTPUT"
                exit 1
              fi
            fi
          fi

          # xcuitest √© apenas para iOS, n√£o necess√°rio em Linux/Android
          # Tentar instalar, mas n√£o falhar se n√£o conseguir
          echo "üì• Tentando instalar xcuitest (opcional para iOS)..."
          appium driver update xcuitest 2>/dev/null || \
          appium driver install xcuitest 2>/dev/null || \
          echo "‚ö†Ô∏è xcuitest n√£o instalado (normal em ambiente Linux/Android)"

          echo "‚úÖ Verifica√ß√£o final dos drivers:"
          appium driver list --installed || echo "Nenhum driver listado"

      - name: Iniciar Appium Server
        run: |
          appium --log appium.log &
          sleep 10

      - name: Executar testes Mobile
        run: |
          echo "üöÄ Iniciando testes Mobile - ${{ matrix.test-file }}..."
          npx wdio mobile-tests/appium.conf.js --spec "mobile-tests/tests/${{ matrix.test-file }}.spec.js"
        env:
          MOBILE_PLATFORM: Android
          MOBILE_DEVICE_NAME: emulator-5554

      - name: Upload relat√≥rio Mobile
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mobile-test-report-${{ matrix.test-file }}
          path: mobile-tests/reports

  generate-report:
    name: Gerar Relat√≥rio Consolidado
    needs: [api-tests, web-tests, load-tests]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Verificar estrutura do projeto
        run: |
          echo "üìÅ Diret√≥rio atual:"
          pwd
          echo ""
          echo "üìÑ Verificando package.json:"
          if [ -f package.json ]; then
            echo "‚úÖ package.json encontrado"
          else
            echo "‚ùå package.json N√ÉO encontrado!"
            exit 1
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"

      - name: Instalar depend√™ncias
        run: |
          echo "üì¶ Verificando arquivos de depend√™ncias..."
          if [ -f package-lock.json ]; then
            echo "‚úÖ package-lock.json encontrado, usando npm ci"
            npm ci
          elif [ -f package.json ]; then
            echo "‚ö†Ô∏è package-lock.json n√£o encontrado, usando npm install"
            npm install
          else
            echo "‚ùå package.json n√£o encontrado!"
            exit 1
          fi

      - name: Baixar artefatos
        uses: actions/download-artifact@v4

      - name: Criar diret√≥rio de relat√≥rios
        run: |
          mkdir -p docs

      - name: Gerar relat√≥rio consolidado detalhado
        run: |
          # Criar arquivo de relat√≥rio
          {
            echo "# üìä Relat√≥rio Detalhado de Testes"
            echo ""
            echo "## üìÖ Informa√ß√µes da Execu√ß√£o"
            echo ""
            echo "- **Data/Hora**: $(date '+%Y-%m-%d %H:%M:%S UTC')"
            echo "- **Commit**: ${{ github.sha }}"
            echo "- **Branch**: ${{ github.ref_name }}"
            echo "- **Workflow**: ${{ github.workflow }}"
            echo "- **Executor**: ${{ github.actor }}"
            echo "- **Run ID**: ${{ github.run_id }}"
            echo ""
            echo "---"
            echo ""
            echo "## üìà Resumo Executivo"
            echo ""
            echo "| Tipo de Teste | Status | Jobs Executados | Detalhes |"
            echo "|--------------|--------|-----------------|----------|"
            echo "| **API Tests** | ${{ needs.api-tests.result }} | 2 jobs (users, posts) | Ver se√ß√£o detalhada abaixo |"
            echo "| **Web E2E Tests** | ${{ needs.web-tests.result }} | 3 jobs (login, navigation, checkout) | Ver se√ß√£o detalhada abaixo |"
            echo "| **Load Tests** | ${{ needs.load-tests.result }} | 1 job (K6) | Ver se√ß√£o detalhada abaixo |"
            echo "| **Mobile Tests** | ‚è≠Ô∏è Skipped | - | Testes mobile s√£o apenas mocks |"
            echo ""
            echo "### üìä Estat√≠sticas Gerais"
            echo ""
            
            # Calcular estat√≠sticas
            TOTAL_JOBS=6
            SUCCESS_COUNT=0
            FAIL_COUNT=0
            
            if [ "${{ needs.api-tests.result }}" = "success" ]; then
              SUCCESS_COUNT=$((SUCCESS_COUNT + 2))
            else
              FAIL_COUNT=$((FAIL_COUNT + 2))
            fi
            
            if [ "${{ needs.web-tests.result }}" = "success" ]; then
              SUCCESS_COUNT=$((SUCCESS_COUNT + 3))
            else
              FAIL_COUNT=$((FAIL_COUNT + 3))
            fi
            
            if [ "${{ needs.load-tests.result }}" = "success" ]; then
              SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
            else
              FAIL_COUNT=$((FAIL_COUNT + 1))
            fi
            
            echo "- **Total de Jobs**: $TOTAL_JOBS jobs executados"
            echo "- **Jobs com Sucesso**: $SUCCESS_COUNT"
            echo "- **Jobs com Falha**: $FAIL_COUNT"
            echo ""
            echo "---"
            echo ""
            echo "## üîç Detalhes por Tipo de Teste"
            echo ""
            echo "### 1. Testes de API (Cypress)"
            echo ""
            echo "**Status Geral**: ${{ needs.api-tests.result }}"
            echo ""
            echo "#### Jobs Executados:"
            echo ""
            echo "- ‚úÖ **users.spec.js**: ${{ needs.api-tests.result }}"
            echo "- ‚úÖ **posts.spec.js**: ${{ needs.api-tests.result }}"
            echo ""
            echo "#### Cobertura:"
            echo ""
            echo "- ‚úÖ GET /users (listagem e busca individual)"
            echo "- ‚úÖ POST /users (cria√ß√£o)"
            echo "- ‚úÖ PUT /users/:id (atualiza√ß√£o)"
            echo "- ‚úÖ DELETE /users/:id (remo√ß√£o)"
            echo "- ‚úÖ GET /posts (listagem, busca e filtros)"
            echo "- ‚úÖ POST /posts (cria√ß√£o)"
            echo "- ‚úÖ PUT /posts/:id (atualiza√ß√£o)"
            echo "- ‚úÖ DELETE /posts/:id (remo√ß√£o)"
            echo "- ‚úÖ Valida√ß√£o de headers e status codes"
            echo "- ‚úÖ Cen√°rios negativos (404, timeouts)"
            echo ""
            echo "#### Artefatos Dispon√≠veis:"
            echo ""
            if [ -d "api-test-videos-users" ] || [ -d "api-test-videos-posts" ]; then
              echo "- üìπ V√≠deos de execu√ß√£o (em caso de falha)"
              echo "- üì∏ Screenshots (em caso de falha)"
            else
              echo "- ‚úÖ Nenhum artefato de falha gerado (todos os testes passaram)"
            fi
            echo ""
            echo "---"
            echo ""
            echo "### 2. Testes Web E2E (Cypress + Cucumber)"
            echo ""
            echo "**Status Geral**: ${{ needs.web-tests.result }}"
            echo ""
            echo "#### Jobs Executados:"
            echo ""
            echo "- ‚úÖ **login.feature**: ${{ needs.web-tests.result }}"
            echo "- ‚úÖ **navigation.feature**: ${{ needs.web-tests.result }}"
            echo "- ‚úÖ **checkout.feature**: ${{ needs.web-tests.result }}"
            echo ""
            echo "#### Cobertura:"
            echo ""
            echo "- ‚úÖ Login com credenciais v√°lidas"
            echo "- ‚úÖ Login com credenciais inv√°lidas"
            echo "- ‚úÖ Valida√ß√£o de campos obrigat√≥rios"
            echo "- ‚úÖ Navega√ß√£o entre p√°ginas"
            echo "- ‚úÖ Fluxo completo de checkout"
            echo "- ‚úÖ Valida√ß√£o de formul√°rios"
            echo ""
            echo "#### Artefatos Dispon√≠veis:"
            echo ""
            if [ -d "web-test-videos-login" ] || [ -d "web-test-videos-navigation" ] || [ -d "web-test-videos-checkout" ]; then
              echo "- üìπ V√≠deos de execu√ß√£o (em caso de falha)"
              echo "- üì∏ Screenshots (em caso de falha)"
            else
              echo "- ‚úÖ Nenhum artefato de falha gerado (todos os testes passaram)"
            fi
            echo ""
            echo "---"
            echo ""
            echo "### 3. Testes de Carga (K6)"
            echo ""
            echo "**Status Geral**: ${{ needs.load-tests.result }}"
            echo ""
            echo "#### Configura√ß√£o:"
            echo ""
            echo "- **Ferramenta**: K6"
            echo "- **Target**: ${{ secrets.API_BASE_URL || 'https://jsonplaceholder.typicode.com' }}"
            echo ""
            echo "#### Cen√°rios de Carga:"
            echo ""
            echo "- ‚úÖ Ramp-up gradual de usu√°rios"
            echo "- ‚úÖ Teste de carga constante"
            echo "- ‚úÖ Ramp-down gradual"
            echo "- ‚úÖ M√∫ltiplos endpoints testados"
            echo ""
            echo "#### Artefatos Dispon√≠veis:"
            echo ""
            if [ -d "k6-report" ]; then
              echo "- üìä Relat√≥rio K6 dispon√≠vel em: k6-report/"
            else
              echo "- ‚úÖ Relat√≥rio dispon√≠vel nos logs da execu√ß√£o"
            fi
            echo ""
            echo "---"
            echo ""
            echo "### 4. Testes Mobile (Appium)"
            echo ""
            echo "**Status**: ‚è≠Ô∏è **Skipped** (apenas mocks)"
            echo ""
            echo "> Os testes mobile foram pulados nesta execu√ß√£o pois s√£o apenas mocks para demonstra√ß√£o."
            echo ""
            echo "---"
            echo ""
            echo "## üì¶ Artefatos e Evid√™ncias"
            echo ""
            echo "### Artefatos Dispon√≠veis no GitHub Actions:"
            echo ""
            echo "Os seguintes artefatos foram gerados e est√£o dispon√≠veis para download:"
            echo ""
            if ls -1 */ 2>/dev/null | grep -qE "(api-test|web-test|k6-report|mobile-test)"; then
              ls -1 */ 2>/dev/null | grep -E "(api-test|web-test|k6-report|mobile-test)" | while read dir; do
                echo "- üìÅ $dir"
              done
            else
              echo "- ‚ÑπÔ∏è Nenhum artefato adicional encontrado no diret√≥rio atual"
            fi
            echo ""
            echo "### Como Acessar os Artefatos:"
            echo ""
            echo "1. V√° para a p√°gina do workflow no GitHub Actions"
            echo "2. Clique no job espec√≠fico que falhou"
            echo "3. Role at√© a se√ß√£o \"Artifacts\""
            echo "4. Baixe o artefato desejado"
            echo ""
            echo "---"
            echo ""
            echo "## üîó Links √öteis"
            echo ""
            echo "- **Workflow Run**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            echo "- **Commit**: ${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}"
            echo "- **Branch**: ${{ github.server_url }}/${{ github.repository }}/tree/${{ github.ref_name }}"
            echo ""
            echo "---"
            echo ""
            echo "## üìù Notas Adicionais"
            echo ""
            echo "- Este relat√≥rio foi gerado automaticamente pelo GitHub Actions"
            echo "- Os testes foram executados em paralelo usando matrix strategy"
            echo "- Todos os jobs foram executados independentemente (fail-fast: false)"
            echo "- Artefatos de v√≠deo e screenshots s√£o gerados apenas em caso de falha"
            echo ""
            echo "---"
            echo ""
            echo "**Gerado em**: $(date '+%Y-%m-%d %H:%M:%S UTC')"
          } > docs/test-report.md

          echo "‚úÖ Relat√≥rio detalhado gerado com sucesso!"
          echo ""
          echo "üìÑ Pr√©via do relat√≥rio:"
          head -30 docs/test-report.md

      - name: Upload relat√≥rio consolidado
        uses: actions/upload-artifact@v4
        with:
          name: consolidated-report
          path: docs/test-report.md
